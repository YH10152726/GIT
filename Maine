1. 工程自動生成機能 (UserForm1)
1.1. セル選択連動 (Worksheet_SelectionChange)

「工程表」シートで選択したセルの情報（材質、サイズ、Z列、備考）をフォームに自動反映し、リアルタイムプレビューを更新する。

1.2. 条件に基づく自動設定・判定

材質選択による自動設定: 材質情報に基づき、仕入先・熱処理業者を自動で選択する。

Z列の自動解析による工程の最適化 (ParseZColumnInfo):

表面処理の指定: 「TICN」「TD」などのキーワードを検出し、コーティング工程を自動追加する。

サブゼロ処理の指定: 「サブゼロ」のキーワードを検出し、熱処理工程を自動調整する。

正規化 (NormalizeZText): 全角/半角/カタカナ/英語などの表記ゆれを統一し、判定精度を向上させる。

1.3. 形状別工程パターン

ブロック形状：標準6回SG

プレート: サイズ文字列からプレート形状を自動判定(ClassifyPartBasedOnSizeString)

ファミリー加工: Y列に「ﾚｲｱｳﾄ」「レイアウト」でファミリー加工を自動判定

レイアウト切り離し後： Y列に「同時」が含まれる場合のレイアウト切り離し後自動設定

1.4. オプション選択による工程分岐

ゲイビ外注: 「材料～焼きまで」など、選択された外注パターンに基づき工程を生成する。

ワイヤ・形状加工: コアレス加工や形状加工といった条件で工程を調整する。

刃付け加工: 刃付け加工の有無を判定し、工程を追加する。

外作購入品: 外作購入品用の工程フローを適用する。

ミスミ購入: ミスミからの購入品用の工程フローを適用する。

1.5. 工程編集機能

リスト操作: プレビューリスト内の工程の順序変更（上下移動）、複製、削除を行う。

工程の手動挿入: 任意の工程をリストに手動で追加する。

工程内容の編集: 工程名、業者、工数（有人/機械/後段取）を手動で修正する。

後段取りの編集: プレビュー上で後段取り時間のみを個別に編集できる。

編集状態の管理: ユーザーが手動で編集した項目を内部的に記録し、プレビューに反映する。

2. 工程表整頓機能
2.1. 親子関係整頓 (SortDoujiKouteiUnderHinban)

Y列の「○○と同時」といった記述を正規表現で検出し、親子関係を特定する。

特定した子部品の工程ブロック全体を、親品番のブロック直下へ自動で移動させる。

無限ループ防止機能を搭載し、安全に処理を実行する。

2.2. 整頓後グループ内の品番順ソート (SortGroupedItemsByTheirOwnAG)

親品番の配下に集約された複数の子部品を、子部品自身の品番（AG列）の昇順に並べ替える。

3. 補助機能
3.1. 次工程間隔設定 (AddNextProcessInterval)

「シート2」の特定セル（Z2）から間隔値（リードタイム）を読み取る。

品名ブロックごとの最終工程（ただし、主材購入、穴あけタップ、熱処理は除く）の行に、読み取った間隔値を自動で入力する。

3.2. 連番管理 (AutoRenumberProcessRemarks)

同一工程が連続する場合、備考欄に「1/3」「2/3」のような連番を自動で付与する。

ただし、「外注」工程は連番の対象外とする。

3.3. 後段取り時間設定 (UpdateGoDandoriTimes)

同一工程グループの最後の工程にのみ、マスターデータに設定された後段取り時間を自動で入力する。

4. ログ・履歴機能
4.1. 出力内容の保存 (LastOutputLogシート)

工程が出力されるたびに、その内容をLastOutputLogシートにバックアップとして保存する。

4.2. 最終出力の再実行 (cmdExecuteLastOutputToActive)

LastOutputLogシートに保存された前回の出力内容を、現在のアクティブセルを基点に再度書き込む。

5. データとコードの構造
5.1. データフロー
| [シート2（マスターデータ）] | | | |
| --- | --- | --- | --- |
|     ├─ A-I列: 工程別の標準工数・備考 | | |
|     ├─ J-M列: 材質情報（仕入先、熱処理業者） | | |
|     ├─ O-R列: 外注先情報 | | | |
|     └─ T-X列: Z列キーワード定義（コーティング種別等） |
|            ↓ | | | | |
| [UserForm1（工程設計）] | | | |
|     ├─ 条件入力 → UpdatePreview | | |
|     ├─ プレビュー表示（ListView） | | |
|     └─ 出力実行 → CommandButton1_Click | | |
|            ↓ | | | | |
| [工程表シート] | | | | |
|     ├─ AJ列: 工程名 | | | |
|     ├─ AK列: 業者 | | | | |
|     ├─ AL-AO列: 工数（前段取/有人/機械/後段取） | |
|     ├─ AR列: 備考 | | | | |
|     └─ Y列: 同時加工情報 | | | |
|            ↓ | | | | |
| [LastOutputLogシート] | | | |
|     └─ 前回出力内容を保存（再出力用） | | |

5.2. コード間の連携

フォーム初期化 (UserForm_Initialize): 起動時に各種Load関数を呼び出し、マスターデータを読み込んでDictionaryオブジェクトに格納する。

シート操作 → フォーム更新: Worksheet_SelectionChangeイベントがRefreshPreviewForActiveCellプロシージャを呼び出し、選択行のデータをフォームに反映させる。

フォーム操作 → フォーム更新: 各種コントロールのClickイベントがUpdatePreviewを呼び出し、AutoRenumberProcessRemarks等の補助機能と連携して、RefreshListBoxFromInternalArrayによりプレビューを更新する。

6. 高度な技術要素と設計思想
6.1. パフォーマンスと安定性への配慮

メモリベースの高速処理: Dictionaryオブジェクトを活用してマスターデータや親子関係をメモリ上で処理し、Excelシートへのアクセスを最小限に抑えることで、大量データでも高速な動作を実現。

堅牢なエラーハンドリング: On Errorステートメントによる予期せぬエラーへの対策や、親子関係の整頓処理における無限ループ防止機能など、ツールの安定稼働を支える仕組みを実装。

6.2. 優れたユーザーエクスペリエンス (UX)

リアルタイムプレビュー: シート選択やフォーム操作に応じて工程プレビューが即座に更新され、試行錯誤しながら直感的に工程を設計できる。

編集内容の保護: プレビューを手動で編集した後に、設定変更で内容が意図せずリセットされることを防ぐ確認メッセージ機能を搭載。

柔軟なプレビュー編集機能: プレビューリスト上で直接、工程の追加・削除・順序変更・複製が可能で、ユーザーの微調整ニーズに柔軟に対応。

6.3. 保守性と拡張性を考慮した設計

マスターデータの分離: 工程、材質、外注先などのビジネスルールをコードから分離し、「シート2」で一元管理。これにより、ルールの追加・変更時にVBAコードを修正する必要がなく、メンテナンスが容易。

正規表現の活用: 「同時」や品番などの複雑な文字列パターンをRegExpオブジェクトで効率的かつ正確に解析し、コードの可読性と信頼性を向上。

モジュール化された構造: 「フォーム処理」「整頓処理」「補助機能」といった役割ごとにコードがモジュール化されており、機能の改修や追加が容易な構造。
